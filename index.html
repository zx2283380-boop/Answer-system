<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è¯¾å ‚ç§¯åˆ†æŠ½é—®ç³»ç»Ÿ-æ•™å¸ˆå¢å¼ºç‰ˆ V8.0</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --warning: #f39c12; --danger: #e74c3c; --info: #3498db; --accent: #e67e22; }
        body { margin: 0; display: flex; height: 100vh; font-family: "Microsoft YaHei", sans-serif; background: #f0f2f5; overflow: hidden; }
        
        /* å·¦ä¾§ç§¯åˆ†ç³»ç»Ÿ */
        #sidebar { width: 350px; border-right: 2px solid #ddd; display: flex; flex-direction: column; background: #fff; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        .naming-section { height: 280px; border-bottom: 2px solid #eee; padding: 20px; text-align: center; background: #fafafa; }
        .ranking-section { flex: 1; overflow-y: auto; padding: 10px; }
        
        .student-card { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .student-card:hover { background: #eef7ff; transform: translateX(5px); }
        .rank-icon { width: 50px; font-weight: bold; font-size: 18px; color: #7f8c8d; }
        .st-name { flex: 1; font-size: 16px; }
        .st-score { font-weight: bold; width: 60px; text-align: right; color: var(--info); }

        .btn-random-name { 
            background: var(--accent); color: white; border: none; padding: 10px 20px; 
            border-radius: 20px; font-size: 18px; font-weight: bold; cursor: pointer;
            margin: 10px 0; width: 80%; transition: 0.2s; box-shadow: 0 4px 0 #d35400;
        }
        .btn-random-name:active { transform: translateY(3px); box-shadow: none; }

        .file-btn { background:none; border:none; color:#666; text-decoration:underline; font-size:12px; cursor:pointer; margin: 2px 5px; }
        .file-btn:hover { color: var(--info); }

        /* å³ä¾§ä¸»é¢æ¿ */
        #main { flex: 1; display: flex; flex-direction: column; }
        .top-nav { height: 75px; background: #fff; display: flex; align-items: center; padding: 0 20px; gap: 15px; border-bottom: 1px solid #ddd; }
        
        /* ä¿®æ”¹ï¼šç§»é™¤å³è¾¹è·ï¼Œå› ä¸ºæ²¡æœ‰+å·äº† */
        .select-wrapper { display: flex; align-items: center; gap: 4px; background: #f8f9fa; padding: 6px 10px; border-radius: 6px; border: 1px solid #eee; }
        select { padding: 5px; border: 1px solid #ccc; border-radius: 4px; min-width: 110px; font-size: 14px; }
        
        .whiteboard { flex: 1; margin: 25px; background: white; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); position: relative; }
        #question-area { font-size: 40px; font-weight: bold; text-align: center; max-width: 90%; color: #333; line-height: 1.4; }
        #answer-area { font-size: 28px; color: var(--danger); margin-top: 35px; display: none; background: #fff5f5; padding: 15px 30px; border-radius: 10px; border: 1px dashed var(--danger); }
        
        .btns { margin-top: 40px; display: flex; gap: 20px; }
        .ctrl-btn { padding: 12px 30px; cursor: pointer; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; transition: 0.2s; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        
        .btn-start { background: var(--info); color: white; font-size: 22px; }
        .btn-check { background: var(--success); color: white; }
        .btn-circle { background: var(--warning); color: white; }
        .btn-cross { background: var(--danger); color: white; }
        
        .icon-btn { cursor: pointer; font-size: 18px; transition: 0.2s; user-select: none; }
        .del-btn { color: var(--danger); }
        .star-btn { color: #f1c40f; }
        /* åˆ é™¤äº† .plus-btn æ ·å¼ */
    </style>
</head>
<body>

<div id="sidebar">
    <div class="naming-section">
        <div style="font-size: 14px; color: #999; margin-bottom: 5px;">æ­£åœ¨æé—®ï¼š</div>
        <div id="current-name" style="font-size: 38px; font-weight: bold; color: var(--accent); min-height: 50px;">ç­‰å¾…æŠ½é—®</div>
        <div id="current-score-val" style="font-size: 18px; color: #7f8c8d; margin-bottom: 10px;">ç§¯åˆ†: --</div>
        
        <button class="btn-random-name" onclick="randomPickStudent()">ğŸ¯ éšæœºç‚¹å</button>
        
        <div style="margin-top: 15px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
            <input type="file" id="stuFile" hidden accept=".xlsx, .xls" onchange="loadStudents(this)">
            <button onclick="document.getElementById('stuFile').click()" class="file-btn">ğŸ“ å¯¼å…¥/æ›´æ–°ç§¯åˆ†è¡¨</button>
            <button onclick="exportData()" class="file-btn" style="color:#27ae60">ğŸ’¾ å¯¼å‡ºæœ€æ–°ç§¯åˆ†è¡¨(Excel)</button>
            <button onclick="clearAllData()" class="file-btn" style="color:#e74c3c">ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰æ•°æ®</button>
        </div>
    </div>
    <div class="ranking-section" id="rank-box"></div>
</div>

<div id="main">
    <div class="top-nav">
        <div class="select-wrapper">
            <select id="sel-book" ondoubleclick="rename(this)"><option value="">é€‰æ‹©ä¹¦</option></select>
            <span class="icon-btn star-btn" title="å¯¼å…¥Excelé¢˜åº“" onclick="prep('book')">â­ï¸</span>
            <span class="icon-btn del-btn" title="åˆ é™¤é€‰ä¸­é¡¹" onclick="deleteOpt('book')">ğŸ—‘ï¸</span>
        </div>
        <div class="select-wrapper">
            <select id="sel-chapter" ondoubleclick="rename(this)"><option value="">é€‰æ‹©ç« </option></select>
            <span class="icon-btn star-btn" title="å¯¼å…¥Excelé¢˜åº“" onclick="prep('chapter')">â­ï¸</span>
            <span class="icon-btn del-btn" title="åˆ é™¤é€‰ä¸­é¡¹" onclick="deleteOpt('chapter')">ğŸ—‘ï¸</span>
        </div>
        <div class="select-wrapper">
            <select id="sel-section" ondoubleclick="rename(this)"><option value="">é€‰æ‹©èŠ‚</option></select>
            <span class="icon-btn star-btn" title="å¯¼å…¥Excelé¢˜åº“" onclick="prep('section')">â­ï¸</span>
            <span class="icon-btn del-btn" title="åˆ é™¤é€‰ä¸­é¡¹" onclick="deleteOpt('section')">ğŸ—‘ï¸</span>
        </div>
        
        <input type="file" id="qFile" hidden onchange="loadQuests(this)">
        <button class="ctrl-btn btn-start" style="margin-left: auto;" onclick="startQuiz()">å¼€å§‹ç­”é¢˜</button>
    </div>

    <div class="whiteboard">
        <div id="question-area">æ¬¢è¿ä½¿ç”¨è¯¾å ‚å›ç­”ç§¯åˆ†ç³»ç»Ÿ</div>
        <div id="answer-area"></div>
        <div class="btns" id="ctrl-panel" style="display:none">
            <button class="ctrl-btn" style="background:#95a5a6; color:white;" onclick="document.getElementById('answer-area').style.display='block'">ğŸ’¡ çœ‹ç­”æ¡ˆ</button>
            <button class="ctrl-btn btn-check" onclick="doScore(5)">âœ”ï¸ +5åˆ†</button>
            <button class="ctrl-btn btn-circle" onclick="doScore(0)">â­• +0åˆ†</button>
            <button class="ctrl-btn btn-cross" onclick="doScore(-5)">âŒ -5åˆ†</button>
        </div>
    </div>
</div>

<script>
    // --- æ•°æ®å˜é‡ ---
    let students = [];
    let qData = { book: {}, chapter: {}, section: {} };
    let curStu = null;
    let upType = '';

    // --- é¡µé¢åŠ è½½æ—¶æ¢å¤æ•°æ® ---
    window.onload = function() {
        const savedStu = localStorage.getItem('class_students');
        const savedQ = localStorage.getItem('class_qdata');

        if (savedStu) {
            students = JSON.parse(savedStu);
            updateRank();
        }
        if (savedQ) {
            qData = JSON.parse(savedQ);
            restoreSelect('book');
            restoreSelect('chapter');
            restoreSelect('section');
        }
    };

    function saveData() {
        localStorage.setItem('class_students', JSON.stringify(students));
        localStorage.setItem('class_qdata', JSON.stringify(qData));
    }

    function restoreSelect(type) {
        const sel = document.getElementById(`sel-${type}`);
        sel.innerHTML = `<option value="">é€‰æ‹©${type==='book'?'ä¹¦':(type==='chapter'?'ç« ':'èŠ‚')}</option>`;
        Object.keys(qData[type]).forEach(name => {
            const opt = document.createElement('option');
            opt.value = name; opt.text = name;
            sel.add(opt);
        });
    }

    // --- å­¦ç”Ÿç®¡ç† ---
    function loadStudents(input) {
        if(!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
            students = json.filter(r => r[0] && r[0] !== "å§“å").map(r => ({
                name: String(r[0]),
                score: parseInt(r[1]) || 0
            }));
            updateRank();
            saveData();
            alert("å­¦ç”Ÿåå•å·²å¯¼å…¥å¹¶è‡ªåŠ¨ä¿å­˜ï¼");
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function updateRank() {
        const box = document.getElementById('rank-box');
        const sorted = [...students].sort((a, b) => b.score - a.score);
        box.innerHTML = '<h4 style="text-align:center;color:#7f8c8d;margin:5px 0;">å®æ—¶ç§¯åˆ†æ’è¡Œæ¦œ</h4>';
        sorted.forEach((s, i) => {
            let rank = i + 1;
            if(rank === 1) rank = "ğŸ¥‡"; else if(rank === 2) rank = "ğŸ¥ˆ"; else if(rank === 3) rank = "ğŸ¥‰";
            const div = document.createElement('div');
            div.className = 'student-card';
            div.onclick = () => focus(s);
            div.innerHTML = `<span class="rank-icon">${rank}</span><span class="st-name">${s.name}</span><span class="st-score">${s.score}åˆ†</span>`;
            box.appendChild(div);
        });
    }

    function focus(s) {
        curStu = s;
        document.getElementById('current-name').innerText = s.name;
        document.getElementById('current-score-val').innerText = `å½“å‰ç§¯åˆ†: ${s.score}`;
    }

    function randomPickStudent() {
        if(students.length === 0) return alert("è¯·å…ˆå¯¼å…¥å­¦ç”Ÿåå•ç§¯åˆ†è¡¨");
        const rStu = students[Math.floor(Math.random() * students.length)];
        focus(rStu);
    }

    // --- é¢˜åº“ç®¡ç† (æ ¸å¿ƒä¿®æ”¹å¤„) ---
    // ç‚¹å‡»æ˜Ÿæ˜Ÿè§¦å‘æ­¤å‡½æ•°ï¼Œè®¾ç½®å½“å‰æ“ä½œç±»å‹å¹¶æ‰“å¼€æ–‡ä»¶é€‰æ‹©
    function prep(t) { upType = t; document.getElementById('qFile').click(); }
    
    function loadQuests(input) {
        if(!input.files[0]) return;
        // è·å–æ–‡ä»¶åä½œä¸ºé€‰é¡¹å
        const name = input.files[0].name.replace(/\.[^/.]+$/, "");
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            // è‡ªåŠ¨æ£€æµ‹å¹¶æ·»åŠ æ–°é€‰é¡¹åˆ°ä¸‹æ‹‰æ¡†
            if(!qData[upType][name]) {
                const sel = document.getElementById(`sel-${upType}`);
                const opt = document.createElement('option');
                opt.value = name; opt.text = name;
                sel.add(opt);
            }
            
            // å­˜å‚¨é¢˜åº“æ•°æ®
            qData[upType][name] = json;
            input.value = ""; // æ¸…ç©ºinputé˜²æ­¢é‡å¤å¯¼å…¥å¤±æ•ˆ
            saveData();
            alert(`å·²å¯¼å…¥é¢˜åº“ï¼šã€${name}ã€‘`);
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function deleteOpt(type) {
        const sel = document.getElementById(`sel-${type}`);
        const val = sel.value;
        if(!val) return alert("è¯·é€‰æ‹©è¦åˆ é™¤é¡¹");
        if(confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤ã€${val}ã€‘åŠå…¶é¢˜åº“å—ï¼Ÿ`)) {
            sel.remove(sel.selectedIndex);
            delete qData[type][val];
            saveData();
        }
    }

    // --- äº’åŠ¨é€»è¾‘ ---
    function startQuiz() {
        const s = document.getElementById('sel-section').value;
        const c = document.getElementById('sel-chapter').value;
        const b = document.getElementById('sel-book').value;
        let pool = [];
        if(s) pool = qData.section[s]; else if(c) pool = qData.chapter[c]; else if(b) pool = qData.book[b];
        if(!pool || pool.length === 0) return alert("æœªå‘ç°é¢˜åº“ï¼Œè¯·å…ˆç‚¹å‡»â­ï¸å¯¼å…¥");
        
        const q = pool[Math.floor(Math.random() * pool.length)];
        const keys = Object.keys(q);
        document.getElementById('question-area').innerText = q[keys[0]];
        document.getElementById('answer-area').innerText = "ç­”æ¡ˆï¼š" + (q[keys[1]] || "æ— ");
        document.getElementById('answer-area').style.display = 'none';
        
        randomPickStudent();
        document.getElementById('ctrl-panel').style.display = 'flex';
    }

    function doScore(p) {
        if(!curStu) return;
        curStu.score += p;
        updateRank();
        focus(curStu);
        saveData();
    }

    function rename(el) {
        const oldName = el.options[el.selectedIndex].text;
        const n = prompt("é‡å‘½åï¼š", oldName);
        if(n && n !== oldName) {
            el.options[el.selectedIndex].text = n;
            el.options[el.selectedIndex].value = n;
            let type = el.id.split('-')[1]; 
            qData[type][n] = qData[type][oldName];
            delete qData[type][oldName];
            saveData();
        }
    }

    // --- å¯¼å‡ºä¸æ¸…ç† ---
    function exportData() {
        if(students.length === 0) return alert("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º");
        const data = [["å§“å", "ç§¯åˆ†"], ...students.map(s => [s.name, s.score])];
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "å­¦ç”Ÿç§¯åˆ†");
        const date = new Date().toISOString().slice(0,10);
        XLSX.writeFile(wb, `è¯¾å ‚ç§¯åˆ†è¡¨_${date}.xlsx`);
    }

    function clearAllData() {
        if(confirm("è­¦å‘Šï¼šè¿™å°†æ¸…ç©ºæ‰€æœ‰å¯¼å…¥çš„å­¦ç”Ÿã€é¢˜åº“å’Œç§¯åˆ†è®°å½•ï¼\nç¡®å®šè¦é‡ç½®å—ï¼Ÿ")) {
            localStorage.removeItem('class_students');
            localStorage.removeItem('class_qdata');
            location.reload();
        }
    }
</script>
</body>
</html>
